<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PURBA MEDINIPUR</title>

<!-- ‚úÖ SheetJS -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
    
<style>
    .watermark{
    font-family: 'Orbitron', sans-serif;
    letter-spacing: 7px;
    font-style: italic;
    position: fixed;
    top: 98%;
    left: 37%;
    transform: translate(-50%, -50%) rotate(0deg);
    font-size: 17px;
    color: #fad457; 
    z-index: 0;
    pointer-events: none;
    user-select: none;
}
    /*watermark complete*/
    
body {
      font-family: 'Bookman Old Style', serif;
      background-color: rgb(241, 252, 251);
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
}
    
h2{color:#333}

th.no-bottom-border {
    border-bottom: none !important;
    }
#search_section{
    display:none;
    margin-top:20px;
    padding:20px;
    background:white;
    border-radius:20px;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
    width:470px;
}

input[type=text]{
    width:100%;
    padding:10px;
    border-radius:7px;
    border:1px solid #ccc;
}

button{
    padding:8px 15px;
    margin-top:8px;
    border:none;
    border-radius:5px;
    cursor:pointer;
    font-weight:bold;
}

#printBtn{background:#ffe066}
#search_btn{background:#a5d8ff}
#prev_btn{background:#c3fae8}
#next_btn{background:#f3d9fa}

table{
    width:100%;
    border-collapse:collapse;
    outline: 2px solid blue;
    margin-top:20px;
    background:white;
    padding:20px;
   
}
th,td{
    border:1px solid #ccc;
    padding:6px;
    text-align:center;
}
th{
    background:#ffffff;
    color: blue;
    border-bottom: 2px solid blue;
}

.summary{
    background:#fff3bf;
    font-size:9px;
    font-weight:bold;
}
.bonus-row {
    background-color: white !important; 
    font-size:10px;
    color: #1414e0;
}
.arrear-row {
    background-color: #f6f7f0 !important; 
    font-size:10px;
    color: #fa3c3c;
}
    /* Infobox Style */
.infobox {
    background: white;
    padding: 20px;
    border-radius: 55px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: relative;
    margin: 30px auto;
    width: 800px;
    height: 237px;
    border-left: 5px solid #ff8400;
    border-right: 5px solid #ff8400;
    text-align: center;
}
.infobox h3 {
    margin-top: 0;
    color: #007bff;
}
.infobox table {
    width: 100%;
    border-collapse: collapse;
}
.infobox td {
    padding: 10px;
    vertical-align: top;
    border-bottom: 1px solid #eee;
    text-align:left
}
.infobox td:first-child {
    font-weight: bold;
    width: 337px;
    color: #555;
    text-align:left;
}
    h3, h4, h5{
    margin-top: 0;
    margin-bottom: 0;
    }
    
/*    h3{
    margin-bottom: 0;
    } */

/* ================= PRINT SETTINGS ================= */
    
@media print {

    /* ‚ùå Hide upload & controls */
    input[type="file"],
    #search_section,
    button, h1 {
        display: none !important;
    }

    th, td {
        padding: 4px;
    }
    
    /* ‚úÖ Clean page */
    body {
        background: white;
        padding: 0;
        margin: 0;
    }

    /* ‚úÖ Tables full width */
    table {
        width: 95% !important;
        height: 57% !important;
        box-shadow: none;
        webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        
    }

    /* ‚úÖ Infobox print friendly */
    .infobox {
        width: 91% !important;
        box-shadow: none;
        border-left: 5px solid #ff8400;
        border-right: 5px solid #ff8400;
        page-break-inside: avoid;
        webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

    /* ‚úÖ Header color force */
    th {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

    /* ‚úÖ Summary row color */
    .summary {
        font-weight: bold;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .watermark{
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
}

    .container {
      width: 100%;
  /*    page-break-before: always; */
    }
  
    .right-border {
      border-right: 2px solid blue;
      line-height: 1.3;
    }
    input[type="number"], input[type="text"] {
      width: 120px;
      text-align: right;
      items-align: right;
    }
    input:disabled {
      background-color: fbffc9;
      color: black;
      font-weight: bold;
    }
    .note { color: red; margin-bottom: 10px; }
    .sub-label { font-size: 0.9em; margin-left: 20px; }
    
 
</style>
</head>

<body>
<div id="loginBox" style="text-align:center;margin-top:100px;">
  <h3>Login required</h3>
  <div id="g_id_onload"
       data-client_id="153331935742-fjjo78i8lp28pj22f95a7bhep6qmmae7.apps.googleusercontent.com"
       data-callback="handleCredentialResponse">
  </div>

  <div class="g_id_signin"
       data-type="standard">
  </div>
</div>

    <div id="salaryContent" style="display:none;">

        <h1>Upload Excel file</h1>
       <input type="file" id="excel_file" accept=".xlsx,.xls,.xlsm">

       <!-- üîç SEARCH SECTION -->
      <div id="search_section">
        <label><b>Search Employee</b></label>
        <input type="text" id="searchBox" list="name_list" placeholder="Enter Name" style="width: 270px; text-align:Left;">
        <datalist id="name_list"></datalist>

      <div style="text-align:center">
        <button id="search_btn">Search</button><br>
        <button id="prev_btn">‚Üê Previous</button>
        <button id="next_btn">Next ‚Üí</button><br>
        <button id="printBtn" onclick="window.print()">Print / PDF</button>
     </div>
      </div></br></br></br></br>
      
    
    <!-- tax calculator table start -->
 <div class="container">
    <h3 style="text-align: center;">STATEMENT OF INCOME (SALARY & OTHER SOURCES) AND INCOME TAX</h3>
    <h4 id="fyTitle" style="text-align:center;"></h4>
    <h3 id="name_Pan" style="text-align:center;"></h3>
    <h5 style="text-align: center;">Name of the Dept:- Education Deptt (Purba Medinipur D.P.S.C.), TAN-CALPO6464D </h5>                                                                  </h4>
     
    <table>
      <thead>
        <tr>
          <th class="right-border">Particulars</th>
          <th>Amount (Rs.)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="text-align: left;" class="right-border">
            1) Gross Salary Income (March,2025 to February 2026):<br>
            2) Less: Standard Deduction U/S 16(Ia):<br>
            3) Income chargeable under the head salaries (1-2):
          </td>
          <td style="text-align: center;">
            <input type="number" id="gsal" oninput="calculateAll()" value="0" step="1" min="0"><br>
            <input type="number" id="sd" value="75000" readonly><br>
            <input type="number" id="net_sal" disabled value="0">
          </td>
        </tr>

        <tr>
          <td style="text-align: left;" class="right-border" >
            4) Add.: Any other Income reported by the employee:<br>
            <span class="sub-label">(a) Income from House property u/s 26 to 27:</span> &ensp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;
            <input type="number" id="oia" value="0" oninput="calculateAll()" style="width: 70px;"><br>
            <span class="sub-label">(b) Income from capital gain (less Income from exempted u/s 10(38):</span> &ensp;
            <input type="number" id="oib" value="0" oninput="calculateAll()" style="width: 70px;"><br>
        
            <span class="sub-label">(c) &ensp;<input type="text" id="oi1_text" style="text-align: left; width: 170px; height: 7px;" placeholder="Mention Source of Income"></span> &emsp;
            <input type="number" id="oi1" value="0" oninput="calculateAll()"><br>
            <span class="sub-label">(d) <input type="text" id="oi2_text" style="text-align: left; width: 170px; height: 7px;" placeholder="Mention Source of Income" ></span> &emsp;
            <input type="number" id="oi2" value="0" oninput="calculateAll()"><br>
            <span class="sub-label">(e) Savings Account Interest:</span> &ensp;&emsp;
            <input type="number" id="oi3" value="0" oninput="calculateAll()"><br>
            <span class="sub-label">(f) Family Pension:</span> &ensp;&emsp;&emsp;&emsp;&emsp;&emsp;
            <input type="number" id="oi4" value="0" oninput="calculateAll()"><br>
            <span class="sub-label" style="color: Red;">&emsp;Less: Deduction U/S 57(IIA):</span> &ensp;&emsp;
            <input type="number" id="oi4e" disabled value="0"><br>
            <span class="sub-label">&emsp;Family Pension after deduction:</span> 
            <input type="number" id="oi4f" disabled value="0"><br>
            <div style="text-align: right; padding-right: 10px;">Total Other Income (a to f):</div>
          </td>
          <td style="vertical-align: bottom; text-align: center;">
            <input type="number" id="tot4" disabled value="0">
          </td>
        </tr>

        <tr>
          <td style="text-align: left;" class="right-border" >
            5) Gross Total Income (3+4):<br>
            <span style="color:red;">6) Less: Deduction U/S. 80CCD(2) NPS (Employer):</span><br>
            7) Taxable Income (5 - 6):<br>
            8) Taxable Income (Rounded off U/S 288A):
          </td>
          <td style="text-align: center;">
            <input type="number" id="tot5" disabled value="0"><br>
            <input type="number" id="NPS" value="0" oninput="calculateAll()"><br>
            <input type="number" id="Taxable_Inc" disabled value="0"><br>
            <input type="number" id="Taxable_Inc_round" disabled value="0">
          </td>
        </tr>

        <tr>
          <td style="text-align: left;" class="right-border" >
            9) Tax on Total Income &emsp;(Salary Slab) &emsp;&emsp;&emsp;&emsp;&emsp; (Tax):<br>
            <small>Upto 4,00,000 (Nil):</small> &emsp;&emsp;&emsp;&emsp; <input type="number" id="sal1" disabled> &emsp;&emsp; <input type="number" id="Tax_slab1" disabled value="0" ><br>
            <small>4,00,001 - 8,00,000 (5%):</small> &ensp;&emsp;&emsp;<input type="number" id="sal2" disabled> &emsp;&emsp; <input type="number" id="Tax_slab2" disabled value="0" ><br>
            <small>8,00,001 - 12,00,000 (10%):</small> &ensp;&emsp;<input type="number" id="sal3" disabled> &emsp;&emsp; <input type="number" id="Tax_slab3" disabled value="0" ><br>
            <small>12,00,001 - 16,00,000 (15%):</small> &emsp;<input type="number" id="sal4" disabled> &emsp;&emsp; <input type="number" id="Tax_slab4" disabled value="0" ><br>
            <small>16,00,001 - 20,00,000 (20%):</small> &emsp;<input type="number" id="sal5" disabled> &emsp;&emsp; <input type="number" id="Tax_slab5" disabled value="0"><br>
            <small>20,00,001 - 24,00,000 (25%):</small> &emsp;<input type="number" id="sal6" disabled> &emsp;&emsp; <input type="number" id="Tax_slab6" disabled value="0"><br>
            <small>Above 24,00,000 (30%):</small> &ensp;&emsp;&emsp;<input type="number" id="sal7" disabled> &emsp;&emsp; <input type="number" id="Tax_slab7" disabled value="0"><br>
            <div style="text-align: Left; font-weight: bold; padding-right: 10px;">10) TOTAL TAX PAYABLE:</div>
          </td>
          <td style="vertical-align: bottom; text-align: center;">
            <input type="number" id="TOTAL_Tax" disabled value="0">
          </td>
        </tr>

        <tr>
          <td style="text-align: left;" class="right-border" >
            11) <span style="color:red;">Less: Rebate u/s 87A maximum of Rs.60,000/- if Sl No. 8 above is below Rs. 12 lakhs:</span><br>
            12) Tax Payable (10-11) :<br>
            13) <span style="color:blue;">Short Term Capital Gain (20%):</span> &emsp;<input type="number" id="st_cg1" value="0" oninput="calculateAll()"><br>
            14) <span style="color:purple;">L.T. Capital Gain (12.5% >1.25L):</span> &ensp;<input type="number" id="lt_cg1" value="0" oninput="calculateAll()"><br>
            15) Total Tax Payable (12+13+14):<br>
            16) Add: Health & Education Cess @4% on Total Tax of Sl No.15:<br>
            17) Total Tax Payable (15+16):<br>
            18) Less: relief u/s 89 if any:<br>
            19) Net Tax Payable (17-18):<br>
            20) Less Tax deducted at source u/s 192(1) upto January,2026 (TDS):<br>

            <input type="text" id="TP_Refund_Text" style="width: 370px; height: 10px; text-align: left; border:none; background:none; font-size:20px; position: relative; left: -10px;" disabled> 
          </td>
          <td style="text-align: center;">
            <input type="number" id="a_87" disabled value="0"><br>
            <input type="number" id="Tax_Pay_able" disabled value="0"><br>
            <input type="number" id="st_cg_2" disabled value="0"><br>
            <input type="number" id="lt_cg_2" disabled value="0"><br>
            <input type="number" id="ttp14" disabled value="0"><br>
            <input type="number" id="Edu_Cess" disabled value="0"><br>
            <input type="number" id="TTP16" disabled value="0"><br>
            <input type="number" id="Rebt89i" value="0" oninput="calculateAll()"><br>
            <input type="number" id="NTP18" disabled value="0"><br>
            <input type="number" id="tds" value="0" oninput="calculateAll()"><br>
            <input type="number" id="Final_Result" disabled value="0">
          </td>
        </tr>
      </tbody>
    </table>
     </div>
    </div>    <br>
     
<div id="table_container"> </div> <!-- Salary Statement table -->
                                                        	

	
<script>
    /*email id checking */
    const allowedEmails = [
        "circlelabpur@gmail.com",
        "ujlmndl@gmail.com",
        "evbasoftware@gmail.com",
        "swapan.bera98@gmail.com"
];

function handleCredentialResponse(response) {
  const data = JSON.parse(atob(response.credential.split('.')[1]));
  const email = data.email;

  if (allowedEmails.includes(email)) {
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("salaryContent").style.display = "block";
  } else {
    alert("Access Denied ‚ùå\nUnauthorized Email");
  }
}
    /*email id checking complete */
    
  // normalize text
const norm = v =>
  String(v || "")
    .toUpperCase()
    .replace(/[\s._-]/g, "");

// safe number
const num = v => isNaN(Number(v)) ? 0 : Number(v);

// flexible match
const like = (a, b) => norm(a).includes(norm(b));

// universal column finder
const findColIndex = (header, keywords=[]) => {
  const map = {};
  header.forEach((h,i)=> map[norm(h)] = i);

  for (let key of keywords) {
    const nk = norm(key);
    for (let h in map) {
      if (h.includes(nk)) return map[h];
    }
  }
  return -1;
};

// universal account matcher
const sameAccount = (a,b) =>
  String(a||"").replace(/\D/g,"") ===
  String(b||"").replace(/\D/g,"");

// detect header row automatically
const detectHeaderRow = rows => {
  for (let i=0;i<rows.length;i++) {
    const r = rows[i].join(" ").toUpperCase();
    if (
      r.includes("BASIC") &&
      (r.includes("DA") || r.includes("PAY"))
    ) return i;
  }
  return -1;
};
    
let year = 2025;
let allMonthlyRows = [];
let otherSheetData = []; 
let currentEmployeeData = null; 
let globalCircleName = "N/A"; 
let globalDistrictName = "N/A";  

document.getElementById("excel_file").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    // ================= PARSE EXCEL FILE =================
reader.onload = ev => {
    const data = new Uint8Array(ev.target.result);
    const wb = XLSX.read(data, { type: "array" });

    allMonthlyRows = [];
    otherSheetData = [];
    globalCircleName = "N/A";
    globalDistrictName= "N/A";

    const MONTHS = [
        "MARCH","APRIL","MAY","JUNE","JULY","AUGUST","SEPTEMBER",
        "OCTOBER","NOVEMBER","DECEMBER","JANUARY","FEBRUARY"
    ];

    wb.SheetNames.forEach(sheetName => {

  // allow ANY sheet containing month name
  const MONTHS = ["JAN","FEB","MAR","APR","MAY","JUN",
                  "JUL","AUG","SEP","OCT","NOV","DEC"];
  if (!MONTHS.some(m => norm(sheetName).includes(m))) return;

  const ws = wb.Sheets[sheetName];
  const rows = XLSX.utils.sheet_to_json(ws,{header:1,defval:""});

  const hIndex = detectHeaderRow(rows);
  if (hIndex === -1) return;

  const header = rows[hIndex];

  rows.slice(hIndex+1).forEach(r=>{
    if (r.join("").trim().length>5) {
      allMonthlyRows.push({
        sheet: sheetName,
        header,
        row: r
      });
    }
  });
});
    // ---------- 2Ô∏è‚É£ READ OTHER SHEET ----------
const otherSheetName =
  wb.SheetNames.find(s => like(s,"OTHER")) || null;

    if (otherSheetName) {
        const ws = wb.Sheets[otherSheetName];
        globalCircleName = String(ws["H4"].v).trim();
        globalDistrictName= String(ws["D4"].v).trim();
        const rows = XLSX.utils.sheet_to_json(ws,{header:1,defval:""});

  const hIndex = rows.findIndex(r =>
    r.join(" ").toUpperCase().includes("BONUS")
  );

  if (hIndex !== -1) {
    const header = rows[hIndex];
    rows.slice(hIndex+1).forEach(r=>{
      otherSheetData.push({header,row:r});
    });
  }
}
    // ---------- 3Ô∏è‚É£ POPULATE SEARCH LIST ----------
    const dataSet = new Set();
    otherSheetData.forEach(it => {
        const name = it.row[2];
        if (name && String(name).trim().length > 3) {
            dataSet.add(String(name).trim());
        }
    });

    const list = document.getElementById("name_list");
    list.innerHTML = "";
    dataSet.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        list.appendChild(opt);
    });

    document.getElementById("search_section").style.display = "block";
    document.getElementById("table_container").innerHTML =
        "<b style='color:green;font-size:18px'>‚úî Excel loaded successfully</b>";
};
    reader.readAsArrayBuffer(file);
});

document.getElementById("search_btn").addEventListener("click", () => {
    const key = document.getElementById("searchBox").value.trim();
    if (!key) return alert("Please enter Name of Teacher");

    // üî¥ STEP‚Äì0: FIRST search ONLY in OTHER sheet
    const keyNorm = key.toUpperCase().trim();

const otherRecord = otherSheetData.find(item =>
    item.row.some(c =>
        String(c || "").toUpperCase().trim() === keyNorm
    )
);


    if (!otherRecord) {
        document.getElementById("table_container").innerHTML =
        `<div style="text-align:center; padding:20px; color:red; font-size:18px;">
            ‚ùå Name "<b>${key}</b>" not found in OTHER sheet
        </div>`;
        return; // ‚õî stop here
    }

    let totalGross = 0, totalNet = 0, total_itax=0;
    
    let totals = {
        BASIC: 0, ADDL: 0, DA: 0, HRA: 0, MA: 0, CONV: 0, DAARR: 0,
        GPF: 0, GSLI: 0, PTAX: 0, ITAX: 0
    };

    let html = `<table style="font-size:11px;">
    <thead>
    <h3 style="color: #8e14e0; position: relative; left: 17px; margin-bottom: 0;">STATEMENT OF SALARY FROM MARCH- ${year} TO FEBRUARY-${year+1} </h3>
       
        <tr>
            <th rowspan="2">MONTH</th>
            <th rowspan="2">BASIC PAY</th>
            <th rowspan="2">ADDL ALW</th>
            <th rowspan="2">DA</th>
            <th rowspan="2">HRA</th>
            <th rowspan="2">MA</th>
            <th rowspan="2">CONV. ALW</th>
           <!-- <th rowspan="2">DA ARR</th> -->
            <th rowspan="2">GROSS TOTAL</th>
            <th colspan="4" class="no-bottom-border">DEDUCTION</th> 
            <th rowspan="2">NET PAY</th>
        </tr>
        <tr class="no-top-border">
            <th>GPF</th>
            <th>GSLI</th>
            <th>P.TAX</th>
            <th>I.TAX</th>
        </tr>
    </thead>
    <tbody>`;
    
    let found = false;
    let bonusAmount = 0;
    let arrearAmount = 0;

    let teacherName = "N/A";
    let schoolName = "N/A";
    let pan = "N/A";
    let mobile = "N/A";
    let designation = "N/A";
    let sex = "N/A";
    let circleName = globalCircleName;
    let distName=globalDistrictName;

     let   othInc1 ="N/A";
     let  othInc1Rs = "N/A";
     let   othInc2 = "N/A";
     let  othInc2Rs = "N/A";
     let   savAccInt = "N/A";
     let   famPen = "N/A";
     let   ccd80_2 = "N/A";
    
    // --- Step A: Get Bonus/Arrear & Employee Info ---
    let accountNo = null;

        
    if (otherRecord) {
        const oMap = {};
        otherRecord.header.forEach((h, i) => oMap[String(h).toUpperCase().trim()] = i);
        
        const getVal = (colName) => {
            let idx = oMap[colName];
            if (idx === undefined) {
                const fuzzyKey = Object.keys(oMap).find(k => k.includes(colName));
                if(fuzzyKey) idx = oMap[fuzzyKey];
            }
            return Number(otherRecord.row[idx] || 0);
        };

        const getTextVal = (colName) => {
            const upperCol = colName.toUpperCase().trim();
            let idx = oMap[upperCol];
            if (idx === undefined) {
                const fuzzyKey = Object.keys(oMap).find(k => k.includes(upperCol));
                if (fuzzyKey) idx = oMap[fuzzyKey];
            }
            if (idx === undefined) return "N/A";
            let val = otherRecord.row[idx];
            if (val == null || val === "" || val === undefined) return "N/A";
            return String(val).trim();
        };

        const getBestText = (cols) => {
            for (let col of cols) {
                let v = getTextVal(col);
                if (v !== "N/A") return v;
            }
            return "N/A";
        };

        accountNo = getBestText(["ACCOUNT NO"]);
        bonusAmount = getVal("BONUS");
        arrearAmount = getVal("ARREAR");

        teacherName = getBestText(["NAME OF THE TEACHER"]);
        schoolName = getBestText(["NAME OF THE SCHOOL"]);
        pan = getTextVal("PAN");
        if (pan !== "N/A") pan = pan.toUpperCase();
        mobile = getBestText(["CONTACT NO."]);
        designation = getBestText(["DESIGNATION"]);
        sex = getBestText(["SEX"]);
 //Other income from OTHER Sheet       
        othInc1 = getBestText(["Source of Other Income (1)"]);
        othInc1Rs = getBestText(["(1) Rs."]);
        othInc2 = getBestText(["Source of Other Income (2)"]);
        othInc2Rs = getBestText(["(2) Rs."]);
        savAccInt = getBestText(["Savings Account Interest"]);
        famPen = getBestText(["Family Pension"]);
        ccd80_2 = getBestText(["80CCD(2)"]);
        
        if (circleName === "N/A") {
             circleName = getBestText(["Circle"]);
        }
    }
    

    // --- Step B: Loop through Monthly Data ---
    allMonthlyRows.forEach(it => {
        if (accountNo && it.row.some(c => String(c || "").trim() === String(accountNo).trim())) {
            found = true;
            
            const map = {};
            it.header.forEach((h, i) => map[String(h).toUpperCase().trim()] = i);
            
            const v = k => {
                 let val = 0;
                 if (map[k] !== undefined) val = Number(it.row[map[k]] || 0);
                 else {
                     const fuzzy = Object.keys(map).find(key => key.startsWith(k.split('.')[0])); 
                     if(fuzzy) val = Number(it.row[map[fuzzy]] || 0);
                 }
                 return val;
            };

            const basic = v("BASIC");
            const addl = v("ADDL. ALLOW");
            const da = v("DA");
            const hra = v("HRA");
            const ma = v("MA");
            const conv = v("CONV ALLOW");
            const daArr = v("DA ARREAR");
            
            const gpf = v("GPF");
            const gsli = v("GSLI");
            const ptax = v("P. TAX") || v("P.TAX") || v("PTAX");
            const itax = v("I.TAX") || v("ITAX");

            totals.BASIC += basic;
            totals.ADDL += addl;
            totals.DA += da;
            totals.HRA += hra;
            totals.MA += ma;
            totals.CONV += conv;
            totals.DAARR += daArr;
            totals.GPF += gpf;
            totals.GSLI += gsli;
            totals.PTAX += ptax;
            totals.ITAX += itax;

            const gross = basic + addl + da + hra + ma + conv + daArr;
            const net = gross - gpf - gsli - ptax - itax;

            totalGross += gross;
            totalNet += net;
            total_itax +=itax;

            let monthName = it.sheet;
            let year2 = year;
            if (["JANUARY", "FEBRUARY"].includes(monthName.toUpperCase())) {
                year2 = year+1;
            }
            const monthWithYear = `${monthName} ${year2}`;
         
            html += `<tr>
                <td><b>${monthWithYear}</b></td>
                <td>${basic}</td>
                <td>${addl}</td>
                <td>${da}</td>
                <td>${hra}</td>
                <td>${ma}</td>
                <td>${conv}</td>
                <!-- <td>${daArr}</td> -->
                <td style="background:#fcf568"><b>${Math.round(gross)}</b></td>
                <td>${gpf}</td>
                <td>${gsli}</td>
                <td>${ptax}</td>
                <td>${itax}</td>
                <td style="background:#c5faef"><b>${Math.round(net)}</b></td>
            </tr>`;

            if (monthName.toUpperCase() === "FEBRUARY") {
                if (bonusAmount > 0) {
                    html += `<tr class="bonus-row">
                        <td><b>BONUS</b></td>
                        <td colspan="6" style="text-align:right; padding-right:20px; font-style:italic;"></td>
                        <td><b>${Math.round(bonusAmount)}</b></td>
                        <td colspan="4"></td>
                        <td><b>${Math.round(bonusAmount)}</b></td>
                    </tr>`;
                    totalGross += bonusAmount;
                    totalNet += bonusAmount;
                }
                if (arrearAmount > 0) {
                    html += `<tr class="arrear-row">
                        <td><b>ARREAR</b></td>
                        <td colspan="6" style="text-align:right; padding-right:20px; font-style:italic;"></td>
                        <td><b>${Math.round(arrearAmount)}</b></td>
                        <td colspan="4"></td>
                        <td><b>${Math.round(arrearAmount)}</b></td>
                    </tr>`;
                    totalGross += arrearAmount;
                    totalNet += arrearAmount;

                }
            }
        }
    });

    html += `<tr class="summary">
        <td>TOTAL (YEARLY)</td>
        <td>${Math.round(totals.BASIC)}</td>
        <td>${Math.round(totals.ADDL)}</td>
        <td>${Math.round(totals.DA)}</td>
        <td>${Math.round(totals.HRA)}</td>
        <td>${Math.round(totals.MA)}</td>
        <td>${Math.round(totals.CONV)}</td>
       <!-- <td>${Math.round(totals.DAARR)}</td> -->
        <td>${Math.round(totalGross)}</td>
        <td>${Math.round(totals.GPF)}</td>
        <td>${Math.round(totals.GSLI)}</td>
        <td>${Math.round(totals.PTAX)}</td>
        <td>${Math.round(total_itax)}</td>
        <td>${Math.round(totalNet)}</td>
    </tr>
    </tbody>
    </table>`;<br><br><br><br>

    
								

    
    // send other iformations in form 16 page
    const safeText = v => {
       if (v === null || v === undefined || String(v).trim() === "") {
            return "";
       }
           return String(v).trim();
       };
    
      localStorage.setItem("YEAR", safeText(year));
      localStorage.setItem("TeacherName", safeText(teacherName));
      localStorage.setItem("PAN", safeText(pan));
    
      localStorage.setItem("OI1", safeText(othInc1));
      localStorage.setItem("OI2", safeText(othInc2));

    const safeNum = v => isNaN(Number(v)) ? "0.00" : Number(v).toFixed(2);
      localStorage.setItem("TOTAL_GROSS", safeNum(totalGross));
      localStorage.setItem("TOTAL_ITAX", safeNum(total_itax));
      localStorage.setItem("OI1RS", safeNum(othInc1Rs));
      localStorage.setItem("OI2RS", safeNum(othInc2Rs));
      localStorage.setItem("SAV_ACC_INT", safeNum(savAccInt));
      localStorage.setItem("FAM_PEN", safeNum(famPen));
      localStorage.setItem("CCD_80_2", safeNum(ccd80_2));

    const container = document.getElementById("table_container");
   
    if (found) {
        let infoboxHtml = '';
        if (otherRecord) {
         /*   infoboxHtml = `<div class="infobox">
                     <h5 style="color: #8e14e0;">STATEMENT OF SALARY FROM MARCH- ${year} TO FEBRUARY-${year+1} </h5>
            
                <table style="font-size:12px;">
                    <tr><td><strong>Teacher Name:</strong> ${teacherName}</td>
                    <td><strong>Designation:</strong> ${designation} &emsp;&emsp;&emsp;
                    <strong>Gender:</strong> ${sex}</td></tr>
                    <tr><td><strong>PAN:</strong> ${pan}</td>
                    <td><strong>Mobile:</strong> ${mobile}</td></tr>
                    <tr><td><strong>School Name:</strong> ${schoolName}</td>
                    <td><strong>Circle Name:</strong> ${circleName}</td></tr>
                    
            </table>
            </div>`; */
        } 
        container.innerHTML = infoboxHtml + html;
    } else {
        container.innerHTML = `<div style="text-align:center; padding:20px; color:red; font-size:18px;">
            ‚ùå No records found for "<b>${key}</b>"
        </div>`;
    }
}); 

function navigateEmployee(direction) {
    const searchBox = document.getElementById("searchBox");
    const list = document.getElementById("name_list");
    const options = Array.from(list.options).map(opt => opt.value);
    
    if (options.length === 0) return;

    let currentIndex = options.indexOf(searchBox.value.trim());

    if (direction === 'next') {
        currentIndex = (currentIndex + 1) % options.length;
    } else {
        currentIndex = (currentIndex - 1 + options.length) % options.length;
    }

    searchBox.value = options[currentIndex];
    document.getElementById("search_btn").click();
}

document.getElementById("prev_btn").addEventListener("click", () => navigateEmployee('prev'));
document.getElementById("next_btn").addEventListener("click", () => navigateEmployee('next'));

    // get gross total from salary statement
  function updateGrossFromStorage() {
    const year = Number(localStorage.getItem("YEAR"));
    const teacher_Name = localStorage.getItem("TeacherName");
    const pan = localStorage.getItem("PAN");
      
    const gross = localStorage.getItem("TOTAL_GROSS");
    const gsalInput = document.getElementById("gsal");
    const itax_tot = localStorage.getItem("TOTAL_ITAX");
    
     //other income
     const othInc1=localStorage.getItem("OI1");
     const othInc1Rs = localStorage.getItem("OI1RS");
     const othInc2 = localStorage.getItem("OI2");
     const othInc2Rs = localStorage.getItem("OI2RS");
     const savAccInt = localStorage.getItem("SAV_ACC_INT");
     const famPen = localStorage.getItem("FAM_PEN");
     const ccd80_2 = localStorage.getItem("CCD_80_2");
    
    if (gross && gsalInput) {
        if (gsalInput.value !== gross) {
            gsalInput.value = Number(gross) || 0;
           // auto recalculation trigger
            if (typeof calculateAll === "function") {
                calculateAll();
            }
        }
        if (itax_tot) document.getElementById("tds").value = Number(itax_tot) || 0;

      // ===== AUTO FILL OTHER INCOME FROM SALARY PAGE =====

      if(year){
    document.getElementById("fyTitle").innerText =
        `Computation Sheet for Financial Year ${year}-${year+1} (Assessment Year ${year+1}-${year+2})`;
      }
      
      if(teacher_Name){
    document.getElementById("name_Pan").innerText =
        `Name of the Employee : ${teacher_Name},  (PAN- ${pan})`;
      }
        
      if (othInc1 !== null) {
         document.getElementById("oi1_text").value = othInc1;
      }

      if (othInc2 !== null) {
         document.getElementById("oi2_text").value = othInc2;
      }

      if (othInc1Rs) document.getElementById("oi1").value = Number(othInc1Rs) || 0;
      if (othInc2Rs) document.getElementById("oi2").value = Number(othInc2Rs) || 0;
      if (savAccInt) document.getElementById("oi3").value = Number(savAccInt) || 0;
      if (famPen) document.getElementById("oi4").value = Number(famPen) || 0;
      if (ccd80_2) document.getElementById("NPS").value = Number(ccd80_2) || 0;

// trigger recalculation
if (typeof calculateAll === "function") calculateAll();

    }
}

// page load ‡¶π‡¶≤‡ßá ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞
window.addEventListener("load", updateGrossFromStorage);

// ‡¶™‡ßç‡¶∞‡¶§‡¶ø 500ms ‡¶™‡¶∞ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶¨‡ßá (real-time sync)
setInterval(updateGrossFromStorage, 500);
  
    function getVal(id) {
      return parseFloat(document.getElementById(id).value) || 0;
    }

    function setVal(id, val) {
      document.getElementById(id).value = val;
    }

    function calculateAll() {
      // 1-3: Salary Calculation
      let gsal = getVal('gsal');
      let sd = getVal('sd');
      let netSal = Math.max(0, gsal - sd);
      setVal('net_sal', netSal);

      // 4: Other Income & Family Pension
    let oia = getVal('oia');
    let oib = getVal('oib');
      let oi1 = getVal('oi1');
      let oi2 = getVal('oi2');
      let oi3 = getVal('oi3');
      let famPen = getVal('oi4');
      
      let famPenDeduct = Math.min(15000, Math.round(famPen / 3));
      let famPenAfter = famPen - famPenDeduct;
      setVal('oi4e', famPenDeduct);
      setVal('oi4f', famPenAfter);

      let totOther = oia + oib + oi1 + oi2 + oi3 + famPenAfter;
      setVal('tot4', totOther);

      // 5-8: Taxable Income
      let gti = netSal + totOther;
      setVal('tot5', gti);
      
      let nps = getVal('NPS');
      let taxableInc = gti - nps;
      let taxableIncRound = Math.round(taxableInc / 10) * 10;
      setVal('Taxable_Inc', taxableInc);
      setVal('Taxable_Inc_round', taxableIncRound);

      // 9: Slab Calculation
      let income = taxableIncRound;
      let s1 = Math.min(income, 400000);
      let s2 = Math.max(0, Math.min(income, 800000) - 400000);
      let s3 = Math.max(0, Math.min(income, 1200000) - 800000);
      let s4 = Math.max(0, Math.min(income, 1600000) - 1200000);
      let s5 = Math.max(0, Math.min(income, 2000000) - 1600000);
      let s6 = Math.max(0, Math.min(income, 2400000) - 2000000);
      let s7 = Math.max(0, income - 2400000);

      setVal('sal1', s1); setVal('Tax_slab1', 0);
      setVal('sal2', s2); setVal('Tax_slab2', Math.round(s2 * 0.05));
      setVal('sal3', s3); setVal('Tax_slab3', Math.round(s3 * 0.10));
      setVal('sal4', s4); setVal('Tax_slab4', Math.round(s4 * 0.15));
      setVal('sal5', s5); setVal('Tax_slab5', Math.round(s5 * 0.20));
      setVal('sal6', s6); setVal('Tax_slab6', Math.round(s6 * 0.25));
      setVal('sal7', s7); setVal('Tax_slab7', Math.round(s7 * 0.30));

      let totalTax = Math.round((s2*0.05)+(s3*0.1)+(s4*0.15)+(s5*0.2)+(s6*0.25)+(s7*0.3));
      setVal('TOTAL_Tax', totalTax);

      // 10: 87A Rebate & Marginal Relief
      let rebate87a = 0;
      if (taxableIncRound <= 1200000) {
        rebate87a = Math.min(totalTax, 60000);
      } else {
        // Marginal Relief logic
        let diff = taxableIncRound - 1200000;
        if (totalTax > diff) {
          rebate87a = totalTax - diff;
        }
      }
      setVal('a_87', Math.round(rebate87a));

      let taxPayable = Math.round(totalTax - rebate87a);
      setVal('Tax_Pay_able', taxPayable);

      // 12-13: Capital Gains
      let stcg = Math.round(getVal('st_cg1') * 0.20);
      let ltcgVal = getVal('lt_cg1');
      let ltcg = ltcgVal > 125000 ? Math.round((ltcgVal - 125000) * 0.125) : 0;
      setVal('st_cg_2', stcg);
      setVal('lt_cg_2', ltcg);

      // 14-16: Total & Cess
      let ttp14 = taxPayable + stcg + ltcg;
      setVal('ttp14', ttp14);
      let cess = Math.round(ttp14 * 0.04);
      setVal('Edu_Cess', cess);
      let ttp16 = ttp14 + cess;
      setVal('TTP16', ttp16);

      // 17-20: Final Result
      let rebate89 = getVal('Rebt89i');
      let ntp18 = ttp16 - rebate89;
      setVal('NTP18', ntp18);
      
      let tds = getVal('tds');
        if ((ntp18 - tds) === 0) {
          setVal('TP_Refund_Text', "21) Tax Payable / Amount Refundable:");
          setVal('Final_Result', 0);
        } else if (ntp18 > tds) {
          setVal('TP_Refund_Text', "21) Tax Payable (19-20):");
          setVal('Final_Result', ntp18 - tds);
      } else {
          setVal('TP_Refund_Text', "21) Amount Refundable (20-19):");
          setVal('Final_Result', tds - ntp18);
      }
    }
 
</script>
        
<div class="watermark">https://aionline.in.net</div>
</body>
</html>
