<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Salary Statement</title>

<!-- ‚úÖ SheetJS -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
    
<style>
    .watermark{
    font-family: 'Orbitron', sans-serif;
    letter-spacing: 7px;
    font-style: italic;
    position: fixed;
    top: 25%;
    left: 27%;
    transform: translate(-50%, -50%) rotate(0deg);
    font-size: 21px;
    color: #fad457; 
    z-index: 0;
    pointer-events: none;
    user-select: none;
}
    /*watermark complete*/
    
body{
    font-family: Arial, sans-serif;
    background:#f4f6f9;
    padding:20px;
}
h2{color:#333}

#search_section{
    display:none;
    margin-top:20px;
    padding:20px;
    background:white;
    border-radius:20px;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
    width:360px;
}

input[type=text]{
    width:100%;
    padding:10px;
    border-radius:20px;
    border:1px solid #ccc;
}

button{
    padding:8px 15px;
    margin-top:8px;
    border:none;
    border-radius:10px;
    cursor:pointer;
    font-weight:bold;
}

#printBtn{background:#ffe066}
#search_btn{background:#a5d8ff}
#prev_btn{background:#c3fae8}
#next_btn{background:#f3d9fa}

table{
    width:100%;
    border-collapse:collapse;
    margin-top:20px;
    background:white;
}
th,td{
    border:1px solid #ccc;
    padding:6px;
    text-align:center;
}
th{
    background:#1971c2;
    color:white;
}

.summary{
    background:#fff3bf;
    font-weight:bold;
}
.bonus-row {
    background-color: white !important; 
    color: #1414e0;
}
.arrear-row {
    background-color: #f6f7f0 !important; 
    color: #fa3c3c;
}
    /* Infobox Style */
.infobox {
    background: white;
    padding: 20px;
    border-radius: 55px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin: 30px 0;
    width: 900px;
    height: 250px;
    border-left: 5px solid #ff8400;
    border-right: 5px solid #ff8400;
    text-align: center;
}
.infobox h3 {
    margin-top: 0;
    color: #007bff;
}
.infobox table {
    width: 100%;
    border-collapse: collapse;
}
.infobox td {
    padding: 10px;
    vertical-align: top;
    border-bottom: 1px solid #eee;
    text-align:left
}
.infobox td:first-child {
    font-weight: bold;
    width: 450px;
    color: #555;
    text-align:left;
}

/* ================= PRINT SETTINGS ================= */
@media print {

    /* ‚ùå Hide upload & controls */
    input[type="file"],
    #search_section,
    button, h1 {
        display: none !important;
    }

    /* ‚úÖ Clean page */
    body {
        background: white;
        padding: 0;
        margin: 0;
    }

    /* ‚úÖ Tables full width */
    table {
        width: 100% !important;
        box-shadow: none;
        webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

    /* ‚úÖ Infobox print friendly */
    .infobox {
        box-shadow: none;
        border-left: 5px solid #ff8400;
        border-right: 5px solid #ff8400;
        page-break-inside: avoid;
        webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

    /* ‚úÖ Header color force */
    th {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

    /* ‚úÖ Summary row color */
    .summary {
        font-weight: bold;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .watermark{
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
}
    
</style>
</head>

<body>
<div id="loginBox" style="text-align:center;margin-top:100px;">
  <h3>Login required</h3>
  <div id="g_id_onload"
       data-client_id="153331935742-fjjo78i8lp28pj22f95a7bhep6qmmae7.apps.googleusercontent.com"
       data-callback="handleCredentialResponse">
  </div>

  <div class="g_id_signin"
       data-type="standard">
  </div>
</div>

    <div id="salaryContent" style="display:none;">

        <h1>Upload Excel file</h1>
       <input type="file" id="excel_file" accept=".xlsx,.xls,.xlsm">

       <!-- üîç SEARCH SECTION -->
      <div id="search_section">
        <label><b>Search Employee</b></label>
        <input type="text" id="searchBox" list="name_list" placeholder="Enter Name">
        <datalist id="name_list"></datalist>

      <div style="text-align:center">
        <button id="search_btn">Search</button><br>
        <button id="prev_btn">‚Üê Previous</button>
        <button id="next_btn">Next ‚Üí</button><br>
        <button id="printBtn" onclick="window.print()">Print / PDF</button>
     </div>
     </div>
     <div id="table_container"></div>
    </div>


<script>
    //email id checking 
    const allowedEmails = [
  "ujlmndl@gmail.com",
  "evbasoftware@gmail.com"
];

function handleCredentialResponse(response) {
  const data = JSON.parse(atob(response.credential.split('.')[1]));
  const email = data.email;

  if (allowedEmails.includes(email)) {
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("salaryContent").style.display = "block";
  } else {
    alert("Access Denied ‚ùå\nUnauthorized Email");
  }
}
    //email id checking complete 
    
  // normalize text
const norm = v =>
  String(v || "")
    .toUpperCase()
    .replace(/[\s._-]/g, "");

// safe number
const num = v => isNaN(Number(v)) ? 0 : Number(v);

// flexible match
const like = (a, b) => norm(a).includes(norm(b));

// universal column finder
const findColIndex = (header, keywords=[]) => {
  const map = {};
  header.forEach((h,i)=> map[norm(h)] = i);

  for (let key of keywords) {
    const nk = norm(key);
    for (let h in map) {
      if (h.includes(nk)) return map[h];
    }
  }
  return -1;
};

// universal account matcher
const sameAccount = (a,b) =>
  String(a||"").replace(/\D/g,"") ===
  String(b||"").replace(/\D/g,"");

// detect header row automatically
const detectHeaderRow = rows => {
  for (let i=0;i<rows.length;i++) {
    const r = rows[i].join(" ").toUpperCase();
    if (
      r.includes("BASIC") &&
      (r.includes("DA") || r.includes("PAY"))
    ) return i;
  }
  return -1;
};
    
let year = 2025;
let allMonthlyRows = [];
let otherSheetData = []; 
let currentEmployeeData = null; 
let globalCircleName = "N/A"; 
let globalDistrictName = "N/A";  

document.getElementById("excel_file").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    // ================= PARSE EXCEL FILE =================
reader.onload = ev => {
    const data = new Uint8Array(ev.target.result);
    const wb = XLSX.read(data, { type: "array" });

    allMonthlyRows = [];
    otherSheetData = [];
    globalCircleName = "N/A";
    globalDistrictName= "N/A";

    const MONTHS = [
        "MARCH","APRIL","MAY","JUNE","JULY","AUGUST","SEPTEMBER",
        "OCTOBER","NOVEMBER","DECEMBER","JANUARY","FEBRUARY"
    ];

    wb.SheetNames.forEach(sheetName => {

  // allow ANY sheet containing month name
  const MONTHS = ["JAN","FEB","MAR","APR","MAY","JUN",
                  "JUL","AUG","SEP","OCT","NOV","DEC"];
  if (!MONTHS.some(m => norm(sheetName).includes(m))) return;

  const ws = wb.Sheets[sheetName];
  const rows = XLSX.utils.sheet_to_json(ws,{header:1,defval:""});

  const hIndex = detectHeaderRow(rows);
  if (hIndex === -1) return;

  const header = rows[hIndex];

  rows.slice(hIndex+1).forEach(r=>{
    if (r.join("").trim().length>5) {
      allMonthlyRows.push({
        sheet: sheetName,
        header,
        row: r
      });
    }
  });
});
    // ---------- 2Ô∏è‚É£ READ OTHER SHEET ----------
const otherSheetName =
  wb.SheetNames.find(s => like(s,"OTHER")) || null;

    if (otherSheetName) {
        const ws = wb.Sheets[otherSheetName];
        globalCircleName = String(ws["H4"].v).trim();
        globalDistrictName= String(ws["D4"].v).trim();
        const rows = XLSX.utils.sheet_to_json(ws,{header:1,defval:""});

  const hIndex = rows.findIndex(r =>
    r.join(" ").toUpperCase().includes("BONUS")
  );

  if (hIndex !== -1) {
    const header = rows[hIndex];
    rows.slice(hIndex+1).forEach(r=>{
      otherSheetData.push({header,row:r});
    });
  }
}
    // ---------- 3Ô∏è‚É£ POPULATE SEARCH LIST ----------
    const dataSet = new Set();
    otherSheetData.forEach(it => {
        const name = it.row[2];
        if (name && String(name).trim().length > 3) {
            dataSet.add(String(name).trim());
        }
    });

    const list = document.getElementById("name_list");
    list.innerHTML = "";
    dataSet.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        list.appendChild(opt);
    });

    document.getElementById("search_section").style.display = "block";
    document.getElementById("table_container").innerHTML =
        "<b style='color:green;font-size:18px'>‚úî Excel loaded successfully</b>";
};
    reader.readAsArrayBuffer(file);
});

document.getElementById("search_btn").addEventListener("click", () => {
    const key = document.getElementById("searchBox").value.trim();
    if (!key) return alert("Please enter Name of Teacher");

    // üî¥ STEP‚Äì0: FIRST search ONLY in OTHER sheet
    const keyNorm = key.toUpperCase().trim();

const otherRecord = otherSheetData.find(item =>
    item.row.some(c =>
        String(c || "").toUpperCase().trim() === keyNorm
    )
);


    if (!otherRecord) {
        document.getElementById("table_container").innerHTML =
        `<div style="text-align:center; padding:20px; color:red; font-size:18px;">
            ‚ùå Name "<b>${key}</b>" not found in OTHER sheet
        </div>`;
        return; // ‚õî stop here
    }

    let totalGross = 0, totalNet = 0, total_itax=0;
    
    let totals = {
        BASIC: 0, ADDL: 0, DA: 0, HRA: 0, MA: 0, CONV: 0, DAARR: 0,
        GPF: 0, GSLI: 0, PTAX: 0, ITAX: 0
    };

    let html = `<table>
    <thead>
        <tr>
            <th>MONTH</th><th>BASIC PAY</th><th>ADDL ALLOW</th><th>DA</th><th>HRA</th>
            <th>MA</th><th>CONV. ALLOW</th>
           <!-- <th>DA ARR</th> -->
            <th>GROSS PAY</th>
            <th>GPF</th><th>GSLI</th><th>P.TAX</th><th>I.TAX</th><th>NET PAY</th>
        </tr>
    </thead>
    <tbody>`;

    let found = false;
    let bonusAmount = 0;
    let arrearAmount = 0;

    let teacherName = "N/A";
    let schoolName = "N/A";
    let pan = "N/A";
    let mobile = "N/A";
    let designation = "N/A";
    let sex = "N/A";
    let circleName = globalCircleName;
    let distName=globalDistrictName;

     let   othInc1 ="N/A";
     let  othInc1Rs = "N/A";
     let   othInc2 = "N/A";
     let  othInc2Rs = "N/A";
     let   savAccInt = "N/A";
     let   famPen = "N/A";
     let   ccd80_2 = "N/A";
    
    // --- Step A: Get Bonus/Arrear & Employee Info ---
    let accountNo = null;

        
    if (otherRecord) {
        const oMap = {};
        otherRecord.header.forEach((h, i) => oMap[String(h).toUpperCase().trim()] = i);
        
        const getVal = (colName) => {
            let idx = oMap[colName];
            if (idx === undefined) {
                const fuzzyKey = Object.keys(oMap).find(k => k.includes(colName));
                if(fuzzyKey) idx = oMap[fuzzyKey];
            }
            return Number(otherRecord.row[idx] || 0);
        };

        const getTextVal = (colName) => {
            const upperCol = colName.toUpperCase().trim();
            let idx = oMap[upperCol];
            if (idx === undefined) {
                const fuzzyKey = Object.keys(oMap).find(k => k.includes(upperCol));
                if (fuzzyKey) idx = oMap[fuzzyKey];
            }
            if (idx === undefined) return "N/A";
            let val = otherRecord.row[idx];
            if (val == null || val === "" || val === undefined) return "N/A";
            return String(val).trim();
        };

        const getBestText = (cols) => {
            for (let col of cols) {
                let v = getTextVal(col);
                if (v !== "N/A") return v;
            }
            return "N/A";
        };

        accountNo = getBestText(["ACCOUNT NO"]);
        bonusAmount = getVal("BONUS");
        arrearAmount = getVal("ARREAR");

        teacherName = getBestText(["NAME OF THE TEACHER"]);
        schoolName = getBestText(["NAME OF THE SCHOOL"]);
        pan = getTextVal("PAN");
        if (pan !== "N/A") pan = pan.toUpperCase();
        mobile = getBestText(["CONTACT NO."]);
        designation = getBestText(["DESIGNATION"]);
        sex = getBestText(["SEX"]);
 //Other income from OTHER Sheet       
        othInc1 = getBestText(["Source of Other Income (1)"]);
        othInc1Rs = getBestText(["(1) Rs."]);
        othInc2 = getBestText(["Source of Other Income (2)"]);
        othInc2Rs = getBestText(["(2) Rs."]);
        savAccInt = getBestText(["Savings Account Interest"]);
        famPen = getBestText(["Family Pension"]);
        ccd80_2 = getBestText(["80CCD(2)"]);
        
        if (circleName === "N/A") {
             circleName = getBestText(["Circle"]);
        }
    }
    

    // --- Step B: Loop through Monthly Data ---
    allMonthlyRows.forEach(it => {
        if (accountNo && it.row.some(c => String(c || "").trim() === String(accountNo).trim())) {
            found = true;
            
            const map = {};
            it.header.forEach((h, i) => map[String(h).toUpperCase().trim()] = i);
            
            const v = k => {
                 let val = 0;
                 if (map[k] !== undefined) val = Number(it.row[map[k]] || 0);
                 else {
                     const fuzzy = Object.keys(map).find(key => key.startsWith(k.split('.')[0])); 
                     if(fuzzy) val = Number(it.row[map[fuzzy]] || 0);
                 }
                 return val;
            };

            const basic = v("BASIC");
            const addl = v("ADDL. ALLOW");
            const da = v("DA");
            const hra = v("HRA");
            const ma = v("MA");
            const conv = v("CONV ALLOW");
            const daArr = v("DA ARREAR");
            
            const gpf = v("GPF");
            const gsli = v("GSLI");
            const ptax = v("P. TAX") || v("P.TAX") || v("PTAX");
            const itax = v("I.TAX") || v("ITAX");

            totals.BASIC += basic;
            totals.ADDL += addl;
            totals.DA += da;
            totals.HRA += hra;
            totals.MA += ma;
            totals.CONV += conv;
            totals.DAARR += daArr;
            totals.GPF += gpf;
            totals.GSLI += gsli;
            totals.PTAX += ptax;
            totals.ITAX += itax;

            const gross = basic + addl + da + hra + ma + conv + daArr;
            const net = gross - gpf - gsli - ptax - itax;

            totalGross += gross;
            totalNet += net;
            total_itax +=itax;

            let monthName = it.sheet;
            let year2 = year;
            if (["JANUARY", "FEBRUARY"].includes(monthName.toUpperCase())) {
                year2 = year+1;
            }
            const monthWithYear = `${monthName} ${year2}`;
         
            html += `<tr>
                <td><b>${monthWithYear}</b></td>
                <td>${basic}</td>
                <td>${addl}</td>
                <td>${da}</td>
                <td>${hra}</td>
                <td>${ma}</td>
                <td>${conv}</td>
                <!-- <td>${daArr}</td> -->
                <td style="background:#fcf568"><b>${gross.toFixed(2)}</b></td>
                <td>${gpf}</td>
                <td>${gsli}</td>
                <td>${ptax}</td>
                <td>${itax}</td>
                <td style="background:#c5faef"><b>${net.toFixed(2)}</b></td>
            </tr>`;

            if (monthName.toUpperCase() === "FEBRUARY") {
                if (bonusAmount > 0) {
                    html += `<tr class="bonus-row">
                        <td><b>BONUS</b></td>
                        <td colspan="6" style="text-align:right; padding-right:20px; font-style:italic;"></td>
                        <td><b>${bonusAmount.toFixed(2)}</b></td>
                        <td colspan="4"></td>
                        <td><b>${bonusAmount.toFixed(2)}</b></td>
                    </tr>`;
                    totalGross += bonusAmount;
                    totalNet += bonusAmount;
                }
                if (arrearAmount > 0) {
                    html += `<tr class="arrear-row">
                        <td><b>ARREAR</b></td>
                        <td colspan="6" style="text-align:right; padding-right:20px; font-style:italic;"></td>
                        <td><b>${arrearAmount.toFixed(2)}</b></td>
                        <td colspan="4"></td>
                        <td><b>${arrearAmount.toFixed(2)}</b></td>
                    </tr>`;
                    totalGross += arrearAmount;
                    totalNet += arrearAmount;

                }
            }
        }
    });

    html += `<tr class="summary">
        <td>TOTAL (YEARLY)</td>
        <td>${totals.BASIC.toFixed(2)}</td>
        <td>${totals.ADDL.toFixed(2)}</td>
        <td>${totals.DA.toFixed(2)}</td>
        <td>${totals.HRA.toFixed(2)}</td>
        <td>${totals.MA.toFixed(2)}</td>
        <td>${totals.CONV.toFixed(2)}</td>
       <!-- <td>${totals.DAARR.toFixed(2)}</td> -->
        <td>${totalGross.toFixed(2)}</td>
        <td>${totals.GPF.toFixed(2)}</td>
        <td>${totals.GSLI.toFixed(2)}</td>
        <td>${totals.PTAX.toFixed(2)}</td>
        <td>${total_itax.toFixed(2)}</td>
        <td>${totalNet.toFixed(2)}</td>
    </tr>
    </tbody>
    </table>`;

    // send other iformations in form 16 page
    const safeText = v => {
       if (v === null || v === undefined || String(v).trim() === "") {
            return "";
       }
           return String(v).trim();
       };
      localStorage.setItem("OI1", safeText(othInc1));
      localStorage.setItem("OI2", safeText(othInc2));

    const safeNum = v => isNaN(Number(v)) ? "0.00" : Number(v).toFixed(2);
      localStorage.setItem("TOTAL_GROSS", safeNum(totalGross));
      localStorage.setItem("TOTAL_ITAX", safeNum(total_itax));
      localStorage.setItem("OI1RS", safeNum(othInc1Rs));
      localStorage.setItem("OI2RS", safeNum(othInc2Rs));
      localStorage.setItem("SAV_ACC_INT", safeNum(savAccInt));
      localStorage.setItem("FAM_PEN", safeNum(famPen));
      localStorage.setItem("CCD_80_2", safeNum(ccd80_2));

    const container = document.getElementById("table_container");
   
    if (found) {
        let infoboxHtml = '';
        if (otherRecord) {
            infoboxHtml = `<div class="infobox">
                <h2 style="color: #1414e0;"> Office of the Sub-Inspector of Schools, ${circleName} Circle, ${distName}</h2>
                 <h4 style="color: #8e14e0;">SALARY STATEMENT FOR THE FINANCIAL YEAR ${year} - ${year+1} (AY ${year+1}-${year+2})</h4>
            
                <table>
                    <tr><td><strong>Teacher Name:</strong> ${teacherName}</td>
                    <td><strong>Designation:</strong> ${designation} &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;
                    <strong>Sex:</strong> ${sex}</td></tr>
                    <tr><td><strong>PAN:</strong> ${pan}</td>
                    <td><strong>Mobile:</strong> ${mobile}</td></tr>
                    <tr><td><strong>School Name:</strong> ${schoolName}</td>
                    <td><strong>Circle Name:</strong> ${circleName}</td></tr>
                    
            </table>
            </div>`;
        }
        container.innerHTML = infoboxHtml + html;
    } else {
        container.innerHTML = `<div style="text-align:center; padding:20px; color:red; font-size:18px;">
            ‚ùå No records found for "<b>${key}</b>"
        </div>`;
    }
});

function navigateEmployee(direction) {
    const searchBox = document.getElementById("searchBox");
    const list = document.getElementById("name_list");
    const options = Array.from(list.options).map(opt => opt.value);
    
    if (options.length === 0) return;

    let currentIndex = options.indexOf(searchBox.value.trim());

    if (direction === 'next') {
        currentIndex = (currentIndex + 1) % options.length;
    } else {
        currentIndex = (currentIndex - 1 + options.length) % options.length;
    }

    searchBox.value = options[currentIndex];
    document.getElementById("search_btn").click();
}

document.getElementById("prev_btn").addEventListener("click", () => navigateEmployee('prev'));
document.getElementById("next_btn").addEventListener("click", () => navigateEmployee('next'));
            
</script>
<div class="watermark">https://aionline.in.net</div>
</body>
</html>
